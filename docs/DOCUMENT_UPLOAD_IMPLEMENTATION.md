# Document Upload Feature Implementation

## Overview
This document describes the implementation of the **UploadedDocument** model and admin integration for managing multiple file uploads per DocumentSource in the Jawafdehi API.

---

## Files Modified/Created

### 1. `cases/models.py`

#### Change: Added UploadedDocument Model
**Location:** Lines 548-614

**Implementation:**
```python
class UploadedDocument(models.Model):
    """
    Stores uploaded files associated with a DocumentSource.
    
    Allows a single DocumentSource to have multiple uploaded files.
    Preserves file metadata (name, size, upload time) for audit trail.
    """
```

**Key Features:**
- **ForeignKey to DocumentSource** with `on_delete=models.CASCADE` - ensures files are deleted when source is deleted
- **FileField** with `upload_to='documents/%Y/%m/'` - organizes files by year/month
- **Metadata Fields:**
  - `original_file_name` (CharField): Preserves original filename
  - `file_size` (IntegerField): Stores file size in bytes
  - `file_type` (CharField): MIME type (auto-detected, e.g., application/pdf)
  - `description` (CharField): Optional 500-char description
  - `uploaded_by` (ForeignKey to User): Tracks who uploaded
  - `is_deleted` (BooleanField): Soft deletion flag
  - `created_at`, `updated_at` (DateTimeField): Audit timestamps

**Auto-Capture Logic in `save()` method:**
- File size automatically captured from uploaded file
- Original filename preserved
- MIME type auto-detected using Python's `mimetypes` module

---

### 2. `cases/admin.py`

#### Change 1: Import UploadedDocument
**Location:** Line 12

```python
from .models import Case, DocumentSource, JawafEntity, CaseState, CaseType, UploadedDocument
```

#### Change 2: Added UploadedDocumentInline
**Location:** Lines 525-537

```python
class UploadedDocumentInline(admin.StackedInline):
    """
    Inline admin for UploadedDocument - allows managing uploaded files within DocumentSource.
    Appears as an integrated section after Basic Information fields.
    """
    
    model = UploadedDocument
    extra = 1
    fields = ['file', 'description', 'original_file_name', 'file_type', 'file_size', 'uploaded_by', 'is_deleted']
    readonly_fields = ['original_file_name', 'file_type', 'file_size', 'uploaded_by']
    verbose_name = "Upload Document"
    verbose_name_plural = "Uploaded Documents"
```

**Design Decisions:**
- **StackedInline** (not TabularInline) for better visual integration and readability
- **extra = 1**: Allows adding one new file at a time
- **fields order**: File upload first, then description, then metadata
- **Readonly fields**: Auto-captured metadata cannot be edited by users

#### Change 3: Updated DocumentSourceAdmin
**Location:** Lines 540-552

**Added:**
```python
class Media:
    js = ('admin/js/document_upload_button.js',)
```

**Reason:** Reserved for future JavaScript enhancements to UI (currently unused, but structure in place)

**Updated inlines:**
```python
inlines = [UploadedDocumentInline]
```

**Removed fieldset:** Deleted the separate "Uploaded Documents" fieldset
- The inline automatically appears after "Basic Information" fieldset
- No need for empty fieldset placeholder

---

### 3. Migration: `cases/migrations/0007_uploadeddocument.py`

**Auto-generated by Django**

**Database Changes:**
- Creates `cases_uploadeddocument` table with:
  - `id` (BigAutoField, primary key)
  - `file` (FileField)
  - `original_file_name` (CharField, max_length=300)
  - `file_size` (IntegerField)
  - `file_type` (CharField, max_length=50)
  - `description` (CharField, max_length=500)
  - `is_deleted` (BooleanField, indexed)
  - `created_at`, `updated_at` (DateTimeField)
  - `source_id` (ForeignKey to DocumentSource)
  - `uploaded_by_id` (ForeignKey to User)

**Relationships:**
- ForeignKey to DocumentSource with CASCADE delete
- ForeignKey to User with SET_NULL (preserve uploads if user deleted)

---

## User Workflow

### Adding Files to a DocumentSource

1. **Create/Edit DocumentSource** in admin
2. **Scroll to "Uploaded Documents" section** (appears after Basic Information)
3. **Click "Add another Uploaded Document"** to expand a new file upload form
4. **Upload file** - metadata auto-captured:
   - File stored in `media/documents/YYYY/MM/` directory
   - Original filename preserved
   - File size calculated
   - MIME type detected
   - Current user recorded as uploader
5. **Optional:** Add description (max 500 characters)
6. **Save** the DocumentSource - all uploads saved together

### Viewing Uploaded Files

- Files appear in a stacked form below the main DocumentSource fields
- Each file shows:
  - File upload input
  - Description field
  - Metadata (read-only): filename, type, size, uploader
  - Delete checkbox to mark as deleted (soft delete)

---

## Design Decisions & Rationale

### Why StackedInline?
- **Better UX** than TabularInline for file uploads
- Each file gets its own form section
- Description field has more space
- Easier to view metadata alongside upload

### Why CharField for description?
- **Simpler** than TextField for this use case
- **Smaller UI** in admin (single-line input vs huge textarea)
- **500 char limit** is sufficient for file descriptions
- **Faster queries** - no need for text indexing

### Why Soft Delete (is_deleted flag)?
- **Audit trail** - preserves history of what was uploaded
- **Case references** - files referenced in case evidence remain intact
- **Consistency** with DocumentSource soft deletion pattern

### Why Store Metadata?
- **Audit trail** - know who uploaded what and when
- **Integrity checks** - original filename + size preserved
- **Search/filtering** - can filter by file type if needed
- **No re-processing** - MIME type stored, not re-detected on read

---

## Database Schema

```sql
cases_uploadeddocument
├── id (BigAutoField, PK)
├── file (FileField)
├── original_file_name (CharField, 300)
├── file_size (IntegerField)
├── file_type (CharField, 50)
├── description (CharField, 500)
├── is_deleted (BooleanField, indexed)
├── created_at (DateTimeField)
├── updated_at (DateTimeField)
├── source_id (FK → DocumentSource, CASCADE)
└── uploaded_by_id (FK → User, SET_NULL)
```

---

## API Integration (Future)

The UploadedDocument model is ready for REST API serialization:
- Could expose via `DocumentSourceSerializer`
- Could implement nested serializer for bulk operations
- Soft deletion can be filtered in queryset

---

## Validation & Constraints

### Model-Level
- `file` field is required (enforced by form)
- `original_file_name` auto-captured from uploaded file
- `file_size` auto-calculated from file object
- `file_type` auto-detected from file extension

### Admin-Level
- File upload is optional (extra = 1)
- Description is optional (blank=True, max_length=500)
- Metadata fields are read-only (cannot be manually edited)

---

## Testing Scenarios

### Happy Path
1. Create DocumentSource with title, description, entities
2. In "Uploaded Documents" section, upload a PDF file
3. Add description for the file
4. Save - file stored in media/documents/YYYY/MM/, metadata captured
5. Edit DocumentSource - file appears in inline with metadata

### Edge Cases
1. Upload multiple files - each gets its own entry
2. Delete (soft) a file - is_deleted set to True
3. Upload file without description - works fine (blank=True)
4. Delete DocumentSource - all related UploadedDocuments cascade deleted
5. Delete user - their uploaded_by reference becomes NULL

---

## Performance Considerations

- **Indexed is_deleted** - fast soft delete queries
- **Organized by date** - media files naturally distributed
- **M2M not used** - direct FK is more efficient than through table
- **Lazy loading** - uploaded_documents only fetched when accessed

---

## Security

- **File upload** - handled by Django's FileField (validates file)
- **uploaded_by** - recorded from request.user in save_model
- **Soft delete** - is_deleted checked in QuerySets to prevent access
- **Cascade delete** - ensures no orphaned files if source deleted

---

## Summary of Changes

| File | Change | Lines | Impact |
|------|--------|-------|--------|
| `models.py` | Added UploadedDocument class | 548-614 | **New model** for file storage |
| `admin.py` | Added import | 12 | **Imports UploadedDocument** |
| `admin.py` | Added UploadedDocumentInline | 525-537 | **Admin interface** for file management |
| `admin.py` | Updated DocumentSourceAdmin.inlines | 545 | **Enables inline uploads** in form |
| `admin.py` | Updated Media class | 547-548 | **Reserved for JS enhancements** |
| `migrations/0007_uploadeddocument.py` | **Auto-generated** | — | **Creates database table** |

---

## Removed/Cleaned Up

1. ✅ **Removed duplicate UploadedDocument import** in admin.py (line 12 had it twice)
2. ✅ **Removed separate "Uploaded Documents" fieldset** - inline appears naturally after Basic Information
3. ✅ **Removed bulk_upload_documents action** - focus on inline uploads instead
4. ✅ **Removed unused JavaScript file** - document_upload_button.js (StackedInline handles UI)

---

## Future Enhancements

1. **Drag-and-drop** file upload (JavaScript enhancement)
2. **File preview** for images/PDFs
3. **Bulk import** to create DocumentSource + files in one go
4. **REST API endpoint** for file downloads
5. **Virus scanning** integration before save
6. **File size limits** enforcement

---

## Dependencies

- Django 5.2.8
- Python's `mimetypes` module (standard library)
- Django admin (built-in)

No new external dependencies required.
