{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Bulk Upload Documents - Jawafdehi Admin{% endblock %}

{% block content %}
<div id="content-main">
    <h1>Bulk Upload Documents</h1>
    
    <p>Upload multiple document files to create new document sources.</p>
    
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
        <h2 style="margin-top: 0;">How it works:</h2>
        <ol>
            <li>Select one or more document files from your computer</li>
            <li>Click "Upload" button</li>
            <li>Each file will be created as a new Document Source entry</li>
            <li>The filename will be used as the document title</li>
            <li>You will be automatically added as a contributor to each document</li>
        </ol>
    </div>
    
    <div id="upload-form-container">
        <form id="bulkUploadForm" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div style="margin-bottom: 15px;">
                <label for="documents" style="display: block; margin-bottom: 5px; font-weight: bold;">
                    Select Documents:
                </label>
                <input 
                    type="file" 
                    id="documents" 
                    name="documents" 
                    multiple 
                    accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.zip"
                    style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;"
                >
                <small style="color: #666; display: block; margin-top: 5px;">
                    Accepted file types: PDF, Word, Excel, Text, Images, ZIP
                </small>
            </div>
            
            <div style="margin-bottom: 15px;">
                <button 
                    type="submit" 
                    class="button default" 
                    style="padding: 8px 15px; background-color: #417690; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
                >
                    Upload Documents
                </button>
                <a href="/admin/cases/documentsource/" class="button" style="padding: 8px 15px; margin-left: 5px; text-decoration: none; display: inline-block; border: 1px solid #ddd; border-radius: 4px;">
                    Back to Document Sources
                </a>
            </div>
        </form>
    </div>
    
    <!-- Results Section -->
    <div id="resultsContainer" style="display: none; margin-top: 30px;">
        <h2>Upload Results</h2>
        
        <div id="successMessage" style="display: none; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 12px; border-radius: 4px; margin-bottom: 15px; color: #155724;">
        </div>
        
        <div id="createdList" style="display: none;">
            <h3>Successfully Created:</h3>
            <ul id="createdItems" style="list-style: none; padding-left: 0;"></ul>
        </div>
        
        <div id="errorList" style="display: none; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 12px; border-radius: 4px; margin-top: 15px; color: #721c24;">
            <h3>Errors:</h3>
            <ul id="errorItems" style="list-style: none; padding-left: 0;"></ul>
        </div>
        
        <div style="margin-top: 20px;">
            <button 
                onclick="location.reload()" 
                class="button default"
                style="padding: 8px 15px; background-color: #417690; color: white; border: none; border-radius: 4px; cursor: pointer;"
            >
                Upload More Documents
            </button>
            <a href="/admin/cases/documentsource/" class="button" style="padding: 8px 15px; margin-left: 5px; text-decoration: none; display: inline-block; border: 1px solid #ddd; border-radius: 4px;">
                View All Documents
            </a>
        </div>
    </div>
</div>

<style>
    #bulkUploadForm {
        background: white;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-width: 600px;
    }
    
    #documents {
        border: 2px dashed #417690 !important;
        padding: 15px !important;
    }
    
    #documents:hover {
        background-color: #f5f5f5;
    }
    
    .success-item {
        background-color: #e8f5e9;
        padding: 10px;
        margin: 5px 0;
        border-left: 4px solid #4caf50;
    }
    
    .error-item {
        background-color: #ffebee;
        padding: 10px;
        margin: 5px 0;
        border-left: 4px solid #f44336;
    }
    
    .loading {
        display: inline-block;
        margin-left: 10px;
        color: #666;
    }
</style>

<script>
document.getElementById('bulkUploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('documents');
    const files = fileInput.files;
    
    if (files.length === 0) {
        alert('Please select at least one file');
        return;
    }
    
    // Disable submit button and show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.innerHTML = originalText + ' <span class="loading">...</span>';
    
    const formData = new FormData();
    Array.from(files).forEach(file => {
        formData.append('documents', file);
    });
    
    fetch('{{ request.path }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        displayResults(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while uploading documents');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});

function displayResults(data) {
    const resultsContainer = document.getElementById('resultsContainer');
    const successMessage = document.getElementById('successMessage');
    const createdList = document.getElementById('createdList');
    const createdItems = document.getElementById('createdItems');
    const errorList = document.getElementById('errorList');
    const errorItems = document.getElementById('errorItems');
    
    // Show results container
    resultsContainer.style.display = 'block';
    
    // Clear previous results
    createdItems.innerHTML = '';
    errorItems.innerHTML = '';
    
    // Display success message
    successMessage.textContent = data.message;
    successMessage.style.display = data.message ? 'block' : 'none';
    
    // Display created sources
    if (data.created && data.created.length > 0) {
        createdList.style.display = 'block';
        data.created.forEach(item => {
            const li = document.createElement('li');
            li.className = 'success-item';
            li.innerHTML = `<strong>${item.filename}</strong><br><small>Source ID: ${item.source_id}</small>`;
            createdItems.appendChild(li);
        });
    } else {
        createdList.style.display = 'none';
    }
    
    // Display errors
    if (data.errors && data.errors.length > 0) {
        errorList.style.display = 'block';
        data.errors.forEach(error => {
            const li = document.createElement('li');
            li.className = 'error-item';
            li.innerHTML = `<strong>${error.filename}:</strong> ${error.error}`;
            errorItems.appendChild(li);
        });
    } else {
        errorList.style.display = 'none';
    }
    
    // Scroll to results
    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>
{% endblock %}
